#!/usr/bin/env luajit

local Mrg    = require('mrg')
local mrg    = Mrg.new(-1, -1);

local path = '/home/pippin/pippin.jpg'

if (#arg >= 1) then
  path = arg[1]
end

mrg:set_ui(
function (mrg, data)
  local cr = mrg:cr()
  local em = mrg:em()
  local w, h = mrg:image_size(path)
  local cr = mrg:cr()
  local scale = 1.0;
  local dw, dh;
    
  scale = (mrg:width ()) / w
  dw, dh = w * scale, h * scale

  if dw > mrg:width()  then
    scale = mrg:width () / w
    dw, dh = w * scale, h * scale
  end
  if dh > mrg:height()  then
    scale = mrg:height()  / h
    dw, dh = w * scale, h * scale
  end
  cr:save()
  cr:translate((mrg:width() - dw)/2, 
              ((mrg:height() - dh)/2))
  mrg:image(0, 0, dw, dh, path)
  cr:restore()

  mrg:add_binding("control-q", NULL, NULL,
    function ()
      mrg:quit()
    end)

  mrg:add_binding("down", NULL, NULL,
    function ()
      mrg:message('next')
      mrg:add_timeout(0,mrg:queue_draw(nil))
    end)
  mrg:add_binding("up", NULL, NULL,
    function ()
      --mrg:message('previous')
      mrg:message('fnord')
      mrg:add_timeout(0,mrg:queue_draw(nil))
    end)

end)

mrg:set_title(path)
mrg:main()
